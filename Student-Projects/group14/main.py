"""
Emotional Advisor Telegram Bot
AI Course Project
Course Project: Artificial Intelligence
University: Tehran Markaz Islamic Azad University
"""

import os
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    MessageHandler,
    filters
)

# =========================
# Configuration
# =========================
# The bot token should be set as an environment variable.
# Example (Linux / Mac):
# export BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"
#
# Example (Windows PowerShell):
# setx BOT_TOKEN "YOUR_TELEGRAM_BOT_TOKEN"

BOT_TOKEN = os.getenv("BOT_TOKEN")

# =========================
# Emotion Database
# =========================
emotions = {
    "استرس": {
        "keywords": ["استرس", "فشار", "خسته", "استرسی"],
        "validation": [
            "می‌فهممت… وقتی استرس طول می‌کشه واقعاً فرساینده می‌شه.",
            "ذهن آدم مدام درگیر بایدها می‌شه.",
            "استرس یعنی یه چیزی برات مهمه، نه ضعف.",
            "لازم نیست الان همه‌چیز رو حل کنی.",
            "اگه بخوای، می‌تونیم آروم درباره‌ش حرف بزنیم."
        ],
        "strategy": [
            "چند دقیقه نفس عمیق بکش و بدن را شل کن.",
            "یک لیست کوتاه از کارهای فوری بساز و بقیه را بعداً انجام بده.",
            "کمی قدم بزن یا حرکات کششی انجام بده.",
            "موزیک آرام‌بخش گوش بده."
        ],
        "book": "هنر ظریف بی‌خیالی – مارک منسن"
    },
    "اضطراب": {
        "keywords": ["اضطراب", "دلشوره", "نگران", "وحشت"],
        "validation": [
            "اضطراب حس عجیبیه؛ بیشتر از آینده میاد تا الان.",
            "بدنت داره سعی می‌کنه محافظتت کنه.",
            "این حس تقصیر تو نیست.",
            "قرار نیست همیشه آروم باشی.",
            "من اینجام، می‌تونی ادامه بدی."
        ],
        "strategy": [
            "تمرین ذهن‌آگاهی انجام بده.",
            "افکارت رو روی کاغذ بنویس.",
            "روی یک فعالیت لذت‌بخش تمرکز کن.",
            "از خودت انتظار کمال نداشته باش."
        ],
        "book": "اضطراب – آلن دوباتن"
    },
    "ناراحتی": {
        "keywords": ["حالم بده", "ناراحتم", "غمگینم", "داغونم", "غم"],
        "validation": [
            "وقتی می‌گی حالت بده یعنی یه چیزی ته دلت سنگینه.",
            "غم نشونه ضعیف بودن نیست.",
            "لازم نیست الان قوی باشی.",
            "این حس هم می‌گذره، حتی اگه الان باورش سخت باشه.",
            "اگه دوست داری، بیشتر بگو."
        ],
        "strategy": [
            "با یک دوست یا مشاور صحبت کن.",
            "فعالیتی که دوست داری انجام بده.",
            "احساساتت رو روی کاغذ بنویس.",
            "نفس عمیق بکش و کمی استراحت کن."
        ],
        "book": "انسان در جستجوی معنا – ویکتور فرانکل"
    },
    "حال خوب": {
        "keywords": ["انرژی", "حال خوب", "انگیزه", "شاد"],
        "validation": [
            "حال خوبت قشنگه.",
            "این انرژی بی‌دلیل نیست.",
            "می‌تونی ازش یه قدم کوچیک بسازی.",
            "لازم نیست عجله کنی.",
            "ادامه بده، مسیرت قابل احترامه."
        ],
        "strategy": [
            "فعالیت‌های روزانه که باعث خوشحالی می‌شن رو ادامه بده.",
            "قدردانی روزانه داشته باش.",
            "به کسی کمک کن، حتی یه کار کوچیک.",
            "لحظات شادی رو ثبت کن یا عکس بگیر."
        ],
        "book": "قدرت عادت – چارلز داهیگ"
    },
    "خشم": {
        "keywords": ["عصبانی", "خشم", "برآشفته", "ناراحت"],
        "validation": [
            "می‌فهمم چقدر عصبانی هستی، حق داری این‌طوری احساس کنی.",
            "انگار فشار زیادی روی تو جمع شده و الان داره بیرون می‌ریزه.",
            "معلومه چیزی عمیقاً ناراحتت کرده، بی‌اهمیت نیست.",
            "وقتی این‌قدر خشمگینی یعنی یه مرزی ازت رد شده.",
            "من اینجام، لازم نیست خشم‌تو قورت بدی و تنها بمونی."
        ],
        "strategy": [
            "چند نفس عمیق بکش و شانه‌ها و بدن را شل کن.",
            "حس خود را روی کاغذ بنویس تا آرام‌تر شوی.",
            "یک پیاده‌روی کوتاه انجام بده یا کمی ورزش سبک."
        ],
        "book": "رقص خشم – هریت لرنر"
    },
    "ترس": {
        "keywords": ["ترس", "می‌ترسم", "وحشت", "ناامن"],
        "validation": [
            "ترست قابل درکه، خیلی وقت‌ها آدم بدون دلیل مشخص هم می‌ترسه.",
            "ذهن تو سعی می‌کنه محافظتت کنه.",
            "ترس تو نشونه ضعف نیست، نشونه مراقبت از خودته.",
            "معلومه ذهنت بدترین حالت‌ها رو تصور می‌کنه.",
            "الان لازم نیست شجاع باشی، فقط نفس بکش."
        ],
        "strategy": [
            "چشم‌هایت را ببند و پنج چیز قابل مشاهده را نام ببر.",
            "نفس عمیق بکش و خود را در لحظه حال زمین‌گیر کن.",
            "به خودت یادآوری کن که ترس فقط سیگنال است، نه فرمان."
        ],
        "book": "با ترس مواجه شو و باز هم انجامش بده – سوزان جفرز"
    },
    "پانیک": {
        "keywords": ["پانیک", "وحشت", "نمی‌توانم نفس بکشم"],
        "validation": [
            "می‌دونم الان حس می‌کنی اوضاع از کنترلت خارجه.",
            "این حس شدید میاد و میره، هرچقدر هم ترسناک باشه.",
            "بدنِت بیش‌ازحد هشدار می‌ده، ولی تو در خطر نیستی.",
            "تمرکزت سخت شده، کاملاً طبیعیِ توی پانیک.",
            "من باهاتم، این موج رد می‌شه."
        ],
        "strategy": [
            "نفس عمیق بکش: ۴ ثانیه دم، ۶ ثانیه بازدم.",
            "پاها را محکم روی زمین قرار بده.",
            "اجازه بده این موج بیاید و برود، بدون جنگیدن."
        ],
        "book": "امید و کمک برای اعصاب شما – کلر ویکس"
    },
    "حسادت": {
        "keywords": ["حسود", "حسادت", "رقابت"],
        "validation": [
            "حسادت یعنی یه چیزی برات مهمه، نه اینکه آدم بدی باشی.",
            "مقایسه شدن خسته‌کننده‌ست، مخصوصاً وقتی خودت دیده نمی‌شی.",
            "می‌شه حسادت رو دید و فهمید، بدون اینکه بذاری کنترلت کنه.",
            "وقتی حسادت میاد، معمولاً یه نیاز دیده‌نشده پشتشه.",
            "می‌شه حسادت رو دید و ازش فهمید چی برات مهمه."
        ],
        "strategy": [
            "تشخیص بده واقعاً چه چیزی برایت مهمه.",
            "تمرکزت را روی اهداف خودت بگذار.",
            "محدود کردن مقایسه با دیگران کمک می‌کنه آرام‌تر باشی."
        ],
        "book": "خودمهربانی – کریستین نف"
    },
    "شرم": {
        "keywords": ["شرم", "خجالت", "ناراحت از خود"],
        "validation": [
            "شرم معمولاً وقتی میاد که فکر می‌کنیم به اندازه‌ی کافی خوب نیستیم.",
            "شرم دروغ می‌گه؛ می‌گه تو خودِ مشکل هستی.",
            "این حس سخت، قابل فهمه ولی تعریف تو نیست.",
            "شرم آدمو کوچیک نشون می‌ده، حتی وقتی واقعیت این نیست.",
            "این حس سخته، ولی به این معنی نیست که تو خراب یا اشتباهی."
        ],
        "strategy": [
            "با خودت مهربان باش و مثل یک دوست با خودت حرف بزن.",
            "این حس را با کسی که اعتماد داری به اشتراک بگذار.",
            "خودت را از موقعیت جدا کن و ارزش واقعی خودت را ببین."
        ],
        "book": "هدایای نقص‌ناپذیری – برنه براون"
    },
    "خجالت": {
        "keywords": ["خجالت", "شرم", "نگرانی از دیده شدن"],
        "validation": [
            "خجالت یعنی داری به ارتباط اهمیت می‌دی، نه اینکه ضعیف باشی.",
            "خیلی‌ها دقیقاً همون لحظه‌هایی که تو خجالت می‌کشی، خودشونم همون حس رو دارن.",
            "خجالت می‌تونه باشه و تو باز هم همون آدم باارزش بمونی.",
            "خجالت یعنی دلت می‌خواد درست دیده بشی.",
            "می‌تونی خجالت بکشی و هم‌زمان شجاع هم باشی."
        ],
        "strategy": [
            "به خودت یادآوری کن که این حس طبیعی است.",
            "تمرکزت روی مهارت‌ها و ارزش‌های خودت باشد.",
            "اجازه بده خجالت بیاید و برود، بدون قضاوت."
        ],
        "book": "قدرت دیده شدن – برنه براون"
    },
    "مبهم": {
        "keywords": [],
        "validation": [
            "می‌فهمم… بعضی وقت‌ها حس آدم مبهمه.",
            "لازم نیست اسم براش بذاری.",
            "همین که داری حرف می‌زنی مهمه.",
            "هر حسی داری، قابل احترامه.",
            "من کنارت هستم."
        ],
        "strategy": [
            "کمی به خودت زمان بده و آرام باش.",
            "نفس عمیق بکش و بدن را شل کن.",
            "کمی قدم بزن یا محیطت را تغییر بده."
        ],
        "book": "تمرین ذهن‌آگاهی – جان کابات زین"
    }
}

# =========================
# Helper Functions
# =========================
def detect_emotion(text: str):
    text = text.lower()
    for emotion, data in emotions.items():
        if any(keyword in text for keyword in data["keywords"]):
            return emotion
    return "مبهم"


def build_response(emotion_key: str):
    data = emotions[emotion_key]
    message = "\n".join(data["validation"]) + "\n\n"
    message += "راهکارهای عملی:\n"
    for s in data["strategy"]:
        message += f"- {s}\n"
    message += f"\nکتاب پیشنهادی:\n{data['book']}"
    return message

# =========================
# Handlers
# =========================
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_text = update.message.text.strip()

    if user_text in ["سلام", "hi", "hello"]:
        await update.message.reply_text("سلام، حالت چطوره؟ چه طور می‌تونم کمکت کنم؟")
        return

    if user_text in ["خدانگهدار", "خداحافظ"]:
        await update.message.reply_text("ممنون که حرف زدی، امیدوارم حالت هر روز بهتر بشه.")
        return

    emotion = detect_emotion(user_text)
    response = build_response(emotion)
    await update.message.reply_text(response)

# =========================
# Main
# =========================
def main():
    if not BOT_TOKEN:
        raise ValueError("BOT_TOKEN is not set. Please define it as an environment variable.")

    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_message))
    print("Your Telegram bot is now running...")
    app.run_polling()

if __name__ == "__main__":
    main()